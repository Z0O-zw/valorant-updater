<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>ç“¦ç½—å…°ç‰¹ 4v4 å¯¹å±€è®°å½•</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ®</text></svg>"">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f8fafc;
    }

    nav button {
      margin-right: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    nav button.active {
      background: black;
      color: white;
    }

    .card {
      background: white;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .player-btn {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      margin: 2px;
    }

    .player-btn.selected {
      background: black;
      color: white;
    }

    img.avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      vertical-align: middle;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th,
    td {
      border-bottom: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }

    .small {
      font-size: 12px;
      color: #555;
    }
  </style>
</head>

<body>

  <h1>ç“¦ç½—å…°ç‰¹ 4v4 å¯¹å±€è®°å½•</h1>

  <nav>
    <button id="tab_players" onclick="showTab('players')" class="active">é€‰æ‰‹ç®¡ç†</button>
    <button id="tab_match" onclick="showTab('match')">è®°å½•å¯¹å±€</button>
    <button id="tab_stats" onclick="showTab('stats')">ç»Ÿè®¡</button>
    <button id="tab_sync" onclick="showTab('sync')">GitHub åŒæ­¥</button>
  </nav>

  <div id="content"></div>

  <script>
    // ---------- é…ç½® ----------
    const repo = "LZWuuu/valorant-undater"; //
    const branch = "master";
    const path = "data.json";
    const token = "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"
    const userDataPath = "src/user.json";
    const henrikapiKey = "HDEV-576c931f-2755-4956-ada1-700b15d77703";

    let players = [];
    let matches = [];
    let selA = [], selB = [], winner = "A";

    // ---------- GitHub è¯»å– ----------
    async function loadDataWithToken() {
      try {
        const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
        const res = await fetch(url, { headers: { Authorization: `token ${token}` } });

        if (!res.ok) {
          console.error('GitHub APIé”™è¯¯:', res.status, res.statusText);
          if (res.status === 401) {
            alert('GitHub Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥tokenæƒé™');
          } else if (res.status === 404) {
            console.log('data.jsonæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            players = [];
            matches = [];
            renderPlayers();
          }
          return;
        }

        const data = await res.json();

        if (!data.content) {
          console.error('GitHub APIæ²¡æœ‰è¿”å›contentå­—æ®µ');
          players = [];
          matches = [];
          renderPlayers();
          return;
        }

        const cleanedContent = data.content.replace(/\s/g, '');
        const bytes = Uint8Array.from(atob(cleanedContent), c => c.charCodeAt(0));
        const jsonStr = new TextDecoder("utf-8").decode(bytes);
        const parsed = JSON.parse(jsonStr);

        players = Array.isArray(parsed.players) ? parsed.players : [];
        matches = Array.isArray(parsed.matches) ? parsed.matches : [];
        renderPlayers();
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        players = [];
        matches = [];
        renderPlayers();
      }
    }


    // ---------- GitHub å†™å…¥ ----------
    async function uploadFileToGithub(token, filePath, file) {
      // å…ˆæŸ¥ shaï¼ˆé¿å… 409 å†²çªï¼‰
      let sha = undefined;
      const checkRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`, {
        headers: { Authorization: `token ${token}` }
      });
      if (checkRes.ok) {
        const { sha: existingSha } = await checkRes.json();
        sha = existingSha;
      }

      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = async e => {
          const content = btoa(e.target.result);
          const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            method: "PUT",
            headers: {
              "Authorization": `token ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: "Upload avatar " + filePath,
              content,
              sha,
              branch
            })
          });
          if (res.ok) {
            resolve(`${filePath}`);
          } else {
            reject(await res.json());
          }
        };
        reader.readAsBinaryString(file);
      });
    }

    async function saveToGithub() {
      const token = prompt("è¯·è¾“å…¥ GitHub Tokenï¼ˆå¿…é¡»æœ‰ repo å†™æƒé™ï¼‰:");
      if (!token) return;

      // 1. å…ˆä¸Šä¼ å¤´åƒ
      for (const [id, file] of Object.entries(avatarFiles)) {
        const pathAvatar = `avatars/${id}_${file.name}`;
        try {
          const url = await uploadFileToGithub(token, pathAvatar, file);
          const player = players.find(p => p.id === id);
          if (player) player.avatar = url;
        } catch (err) {
          console.error("ä¸Šä¼ å¤´åƒå¤±è´¥:", err);
          alert("âŒ ä¸Šä¼ å¤´åƒå¤±è´¥: " + (err.message || JSON.stringify(err)));
        }
      }
      avatarFiles = {}; // æ¸…ç©ºç¼“å­˜

      // 2. ä¸Šä¼  data.json
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
        headers: { Authorization: `token ${token}` }
      });
      if (!getRes.ok) {
        const err = await getRes.json();
        alert("è·å– data.json å¤±è´¥: " + (err.message || getRes.status));
        return;
      }
      const { sha } = await getRes.json();

      const newData = { players, matches };
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(newData, null, 2))));

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Update match data",
          content: encoded,
          sha,
          branch
        })
      });

      const out = await res.json();
      if (res.ok) {
        alert("âœ… å·²ä¿å­˜åˆ° GitHub");
      } else {
        alert("âŒ ä¿å­˜å¤±è´¥: " + res.status + " " + (out.message || ""));
      }
    }


    // ---------- Tab åˆ‡æ¢ ----------
    function showTab(tab) {
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      document.getElementById("tab_" + tab).classList.add("active");
      if (tab === "players") renderPlayers();
      if (tab === "match") renderMatch();
      if (tab === "stats") renderStats();
      if (tab === "sync") renderSync();
    }

    // ---------- ç©å®¶ç®¡ç† ----------
    function addPlayer() {
      if (!Array.isArray(players)) players = [];
      const newId = Date.now().toString();
      players.push({ id: newId, name: "æ–°ç©å®¶", wins: 0, losses: 0, avatar: "" });
      renderPlayers();

    }

    function addMatch() {
      if (selA.length !== 4 || selB.length !== 4) return alert("å¿…é¡»é€‰æ‹©ä¸¤æ”¯4äººé˜Ÿä¼");
      const m = { id: Date.now(), teamA: [...selA], teamB: [...selB], winner };
      matches.unshift(m);
      m.teamA.forEach(id => { const p = players.find(x => x.id === id); if (winner === "A") p.wins++; else p.losses++; });
      m.teamB.forEach(id => { const p = players.find(x => x.id === id); if (winner === "B") p.wins++; else p.losses++; });
      selA = []; selB = []; winner = "A";
      renderMatch();
      alert("âš ï¸ å·²æ·»åŠ å¯¹å±€ï¼Œè¯·ç‚¹å‡»ã€ä¿å­˜æ•°æ®åˆ° GitHubã€‘ä¸Šä¼ ï¼Œå¦åˆ™å…¶ä»–äººçœ‹ä¸åˆ°");
    }

    let avatarFiles = {}; // ä¸´æ—¶ç¼“å­˜å¾…ä¸Šä¼ å¤´åƒ {playerId: File}
    async function fetchAvatar(filePath) {
      const url = `https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`;
      const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
      if (!res.ok) {
        console.error("å¤´åƒè¯·æ±‚å¤±è´¥:", res.status, res.statusText);
        return 'https://via.placeholder.com/40';
      }
      const data = await res.json();
      if (!data.content) {
        console.error("API æ²¡æœ‰è¿”å› content:", data);
        return 'https://via.placeholder.com/40';
      }
      return "data:image/png;base64," + data.content;
    }

    function uploadAvatar(idx, file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        players[idx].avatar = e.target.result; // æœ¬åœ°é¢„è§ˆç”¨
        avatarFiles[players[idx].id] = file;   // ä¿å­˜åˆ°ç¼“å­˜ï¼Œç­‰ä¿å­˜æ—¶ä¸Šä¼ 
        renderPlayers();
      };
      reader.readAsDataURL(file);
    }

    function renderPlayers() {
      const c = document.getElementById("content");
      c.innerHTML = "";


      if (!players || players.length === 0) {
        const emptyDiv = document.createElement("div");
        emptyDiv.className = "card";
        emptyDiv.innerText = "æš‚æ— ç©å®¶ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ";
        c.appendChild(emptyDiv);
      }
      // âœ… å§‹ç»ˆæç¤ºéœ€è¦ä¿å­˜
      const tip = document.createElement("p");
      tip.className = "small";
      tip.innerText = "âš ï¸ æ³¨æ„ï¼šä¿®æ”¹ç©å®¶åéœ€è¦ç‚¹å‡»ã€ä¿å­˜å½“å‰æ•°æ®åˆ° GitHubã€‘ä¸Šä¼ ï¼Œå¦åˆ™å…¶ä»–äººçœ‹ä¸åˆ°";
      c.appendChild(tip);

      // âœ… æç¤ºå¤´åƒæ–‡ä»¶éœ€å°äº 1MB
      const tip2 = document.createElement("p");
      tip2.className = "small";
      tip2.innerText = "âš ï¸ æ³¨æ„ï¼šå¤´åƒæ–‡ä»¶éœ€å°äº 1MB";
      c.appendChild(tip2);

      players.forEach((p, i) => {
        
        const div = document.createElement("div");
        div.className = "card";
        let avatarSrc = "https://via.placeholder.com/40";
        if (p.avatar && p.avatar.startsWith("avatars/")) {
          fetchAvatar(p.avatar).then(url => {
            const imgEl = div.querySelector("#avatar_" + p.id);
            if (imgEl) imgEl.src = url;
          });
        } else if (p.avatar) {
          avatarSrc = p.avatar;
        }

        
        div.innerHTML = `
      <img id="avatar_${p.id}" class="avatar" src=${avatarSrc}>
      <input value="${p.name}" onchange="players[${i}].name=this.value; renderPlayers()"><br>
      <span class="small">èƒœ ${p.wins || 0} / è´Ÿ ${p.losses || 0}</span><br>
      <input type="file" accept="image/*" onchange="uploadAvatar(${i},this.files[0])"><br>
      <button onclick="deletePlayer(${i})">åˆ é™¤é€‰æ‰‹</button>
    `;



        c.appendChild(div);
      });

      // âœ… å§‹ç»ˆåŠ ä¸Šâ€œæ·»åŠ é€‰æ‰‹â€æŒ‰é’®
      const addBtn = document.createElement("button");
      addBtn.innerText = "â• æ·»åŠ é€‰æ‰‹";
      addBtn.onclick = () => addPlayer();
      c.appendChild(addBtn);

      

    }

    // ---------- å¯¹å±€è®°å½• ----------
    function togglePick(team, id) {
      let arr = team === "A" ? selA : selB;
      if (arr.includes(id)) arr.splice(arr.indexOf(id), 1);
      else if (arr.length < 4 && !selA.concat(selB).includes(id)) arr.push(id);
      renderMatch();
    }

    function addMatch() {
      if (selA.length !== 4 || selB.length !== 4) return alert("å¿…é¡»é€‰æ‹©ä¸¤æ”¯4äººé˜Ÿä¼");
      const m = { id: Date.now(), teamA: [...selA], teamB: [...selB], winner };
      matches.unshift(m);
      // æ›´æ–°èƒœè´Ÿ
      m.teamA.forEach(id => { const p = players.find(x => x.id === id); if (winner === "A") p.wins++; else p.losses++; });
      m.teamB.forEach(id => { const p = players.find(x => x.id === id); if (winner === "B") p.wins++; else p.losses++; });
      selA = []; selB = []; winner = "A";
      renderMatch();
    }
    function deleteMatch(i) {
      if (confirm("ç¡®å®šè¦åˆ é™¤è¿™åœºå¯¹å±€å—ï¼Ÿ")) {
        matches.splice(i, 1);
        renderMatch();
      }
    }
    function renderMatch() {
      const c = document.getElementById("content");
      c.innerHTML = "";

      // é˜Ÿä¼é€‰æ‹©åŒº
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
    <h3>é€‰æ‹©é˜Ÿä¼</h3>
    <div>
      <b>Aé˜Ÿ</b><br>
      ${players.map(p =>
        `<span class="player-btn ${selA.includes(p.id) ? 'selected' : ''}" 
          onclick="togglePick('A','${p.id}')">${p.name}</span>`
      ).join(" ")}
    </div>
    <div>
      <b>Bé˜Ÿ</b><br>
      ${players.map(p =>
        `<span class="player-btn ${selB.includes(p.id) ? 'selected' : ''}" 
          onclick="togglePick('B','${p.id}')">${p.name}</span>`
      ).join(" ")}
    </div>
    <p>
      èƒœè€…:
      <label><input type="radio" name="win" ${winner === "A" ? "checked" : ""} onchange="winner='A'">Aé˜Ÿ</label>
      <label><input type="radio" name="win" ${winner === "B" ? "checked" : ""} onchange="winner='B'">Bé˜Ÿ</label>
    </p>
    <button onclick="addMatch()">ä¿å­˜å¯¹å±€</button>
    <p class="small">âš ï¸ æ³¨æ„ï¼šæ·»åŠ å¯¹å±€åéœ€è¦ç‚¹å‡»ã€ä¿å­˜æ•°æ®åˆ° GitHubã€‘ä¸Šä¼ ï¼Œå¦åˆ™å…¶ä»–äººçœ‹ä¸åˆ°</p>
  `;
      c.appendChild(div);

      // å¯¹å±€åˆ—è¡¨
      const listTitle = document.createElement("h3");
      listTitle.innerText = "æœ€è¿‘å¯¹å±€";
      c.appendChild(listTitle);

      matches.forEach((m, idx) => {
        const d = document.createElement("div");
        d.className = "card small";

        const teamA = m.teamA.map(id => players.find(p => p.id === id)?.name || "æœªçŸ¥").join(", ");
        const teamB = m.teamB.map(id => players.find(p => p.id === id)?.name || "æœªçŸ¥").join(", ");

        d.innerHTML = `
      <div><b>${new Date(m.id).toLocaleString()}</b></div>
      <div>Aé˜Ÿ: ${teamA}</div>
      <div>Bé˜Ÿ: ${teamB}</div>
      <div>èƒœè€…: ${m.winner}</div>
      <button onclick="deleteMatch(${idx})">åˆ é™¤è¯¥å¯¹å±€</button>
    `;
        c.appendChild(d);
      });
    }

    function renderStats() {
      const c = document.getElementById("content");
      c.innerHTML = "<h2>ä¸ªäººç»Ÿè®¡ï¼ˆæŒ‰èƒœç‡æ’åºï¼‰</h2>";

      // ---- ç©å®¶ç»Ÿè®¡ï¼ˆæŒ‰èƒœç‡æ’åºï¼‰----
      const sortedPlayers = [...players].map(p => {
        const total = p.wins + p.losses;
        const wr = total ? p.wins / total : 0;
        return { ...p, total, wr };
      }).sort((a, b) => b.wr - a.wr || b.total - a.total);
      // âš¡ èƒœç‡é«˜çš„åœ¨å‰ï¼Œèƒœç‡ç›¸åŒçš„æŒ‰å¯¹å±€æ•°å¤šçš„åœ¨å‰

      const table = document.createElement("table");
      table.innerHTML = `
    <tr><th>æ’å</th><th>ç©å®¶</th><th>å¯¹å±€</th><th>èƒœ</th><th>è´Ÿ</th><th>èƒœç‡</th></tr>
    ${sortedPlayers.map((p, idx) => {
        const wrPercent = Math.round(p.wr * 100);
        return `<tr>
        <td>${idx + 1}</td>
        <td>${p.name}</td>
        <td>${p.total}</td>
        <td>${p.wins}</td>
        <td>${p.losses}</td>
        <td>${wrPercent}%</td>
      </tr>`;
      }).join("")}
  `;
      c.appendChild(table);

      // ---- ç»„åˆç»Ÿè®¡ ----
      const comboStats = {};
      function addCombo(ids, win) {
        const key = ids.sort().join("-");
        if (!comboStats[key]) comboStats[key] = { played: 0, wins: 0, ids: [...ids] };
        comboStats[key].played++;
        if (win) comboStats[key].wins++;
      }

      function combinations(arr, k) {
        if (k === 1) return arr.map(x => [x]);
        if (k === arr.length) return [arr];
        let res = [];
        for (let i = 0; i <= arr.length - k; i++) {
          const head = arr[i];
          const tail = combinations(arr.slice(i + 1), k - 1);
          tail.forEach(t => res.push([head, ...t]));
        }
        return res;
      }

      matches.forEach(m => {
        // A é˜Ÿ 2äººã€3äººç»„åˆ
        combinations(m.teamA, 2).forEach(cmb => addCombo(cmb, m.winner === "A"));
        combinations(m.teamA, 3).forEach(cmb => addCombo(cmb, m.winner === "A"));
        // B é˜Ÿ
        combinations(m.teamB, 2).forEach(cmb => addCombo(cmb, m.winner === "B"));
        combinations(m.teamB, 3).forEach(cmb => addCombo(cmb, m.winner === "B"));
      });

      const combos = Object.values(comboStats)
        .filter(c => c.played >= 2)
        .map(c => ({ ...c, wr: c.wins / c.played }))
        .sort((a, b) => b.wr - a.wr || b.played - a.played);

      if (combos.length > 0) {
        // æœ€ä½³ TOP 3
        const bestWr = combos[0].wr; // æ’åºåç¬¬ä¸€ä¸ªå°±æ˜¯æœ€é«˜èƒœç‡
        const bestCombos = combos.filter(c => c.wr === bestWr);

        const bestDiv = document.createElement("div");
        bestDiv.className = "card";
        bestDiv.innerHTML = "<b>æœ€ä½³ç»„åˆï¼š</b><br>" +
          bestCombos.map(c => {
            const names = c.ids.map(id => players.find(p => p.id === id).name).join(" + ");
            return `${names} â†’ ${(c.wr * 100).toFixed(1)}% (${c.wins}/${c.played})`;
          }).join("<br>");
        c.appendChild(bestDiv);

        // æœ€å·®ç»„åˆ
        const worstWr = combos[combos.length - 1].wr;
        const worstCombos = combos.filter(c => c.wr === worstWr);

        const worstDiv = document.createElement("div");
        worstDiv.className = "card";
        worstDiv.innerHTML = "<b>æœ€å·®ç»„åˆï¼š</b><br>" +
          worstCombos.map(c => {
            const names = c.ids.map(id => players.find(p => p.id === id).name).join(" + ");
            return `${names} â†’ ${(c.wr * 100).toFixed(1)}% (${c.wins}/${c.played})`;
          }).join("<br>");
        c.appendChild(worstDiv);
      }
    }



    // ---------- GitHub åŒæ­¥ Tab ----------
    function renderSync() {
      const c = document.getElementById("content");
      c.innerHTML = `
    <div class="card">
      <h2>GitHub åŒæ­¥</h2>
      <button onclick="const t=prompt('è¯·è¾“å…¥ GitHub Token'); if(t) loadDataWithToken(t)">ä» GitHub æ‹‰å–æœ€æ–°æ•°æ®</button>
      <button onclick="saveToGithub()">ä¿å­˜å½“å‰æ•°æ®åˆ° GitHub</button>
      <p class="small">âš ï¸ å†™å…¥éœ€è¦è¾“å…¥ GitHub Tokenï¼ˆå¿…é¡»å¯¹æœ¬ä»“åº“æœ‰å†™æƒé™ï¼‰ã€‚</p>
    </div>
  `;
    }

    // ---------- ç”¨æˆ·æ•°æ®æ›´æ–° ----------

    async function updateUserData() {
      try {
        const userDataRes = await fetch(`https://api.github.com/repos/${repo}/contents/${userDataPath}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });
        if (!userDataRes.ok) {
          console.log("user.json not found on GitHub, skipping update");
          return;
        }

        const userData = await userDataRes.json();
        const userJson = JSON.parse(atob(userData.content));

        const matchListUrl = `https://api.henrikdev.xyz/valorant/v3/matches/eu/SuperLulino/4088?mode=custom`;
        const matchRes = await fetch(matchListUrl, {
          headers: { "Authorization": henrikapiKey }
        });

        if (!matchRes.ok) return;

        const matchData = await matchRes.json();
        const userPuuids = userJson.players.map(p => p.puuid);

        if (matchData.data && Array.isArray(matchData.data)) {
          for (const match of matchData.data) {
            if (match.metadata?.mode === "custom" || match.metadata?.mode_id === "custom") {
              const matchPlayers = match.players?.all_players || [];
              const matchPuuids = matchPlayers.map(p => p.puuid);

              const allPuuidsMatch = userPuuids.every(puuid => matchPuuids.includes(puuid));

              if (allPuuidsMatch && matchPuuids.length === 8) {
                userJson.newestMatchID = match.metadata.matchid;

                userJson.players = userJson.players.map(player => {
                  const matchPlayer = matchPlayers.find(p => p.puuid === player.puuid);
                  if (matchPlayer) {
                    player.name = matchPlayer.name;
                    player.tag = matchPlayer.tag;
                    player.card = matchPlayer.assets?.card?.small || "";
                  }
                  return player;
                });

                await saveUserData(userJson, userData.sha);
                break;
              }
            }
          }
        }
      } catch (error) {
        console.error("Error updating user data:", error);
      }
    }

    async function saveUserData(userJson, sha) {
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(userJson, null, 4))));

      await fetch(`https://api.github.com/repos/${repo}/contents/${userDataPath}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Update user data",
          content: encoded,
          sha: sha,
          branch: branch
        })
      });
    }

    // ---------- åˆå§‹åŒ– ----------
    addEventListener('DOMContentLoaded', async () => {
      await updateUserData();
      await loadDataWithToken();
      document.getElementById('tab_players')?.click();
    });

  </script>

</body>

</html>